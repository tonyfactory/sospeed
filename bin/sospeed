#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

require 'optparse'
require_relative '../lib/sospeed'

# コマンドラインオプション解析
def parse_options
  options = {}

  OptionParser.new do |opts|
    opts.banner = "使用方法: ruby bin/sospeed [オプション]"
    opts.separator ""
    opts.separator "オプション:"

    opts.on("--level LEVEL", Integer, "難易度を指定 (1-4)") do |level|
      unless (1..4).include?(level)
        puts "=" * 60
        puts "エラー: レベルは1〜4の範囲で指定してください"
        puts "=" * 60
        puts ""
        puts "利用可能なレベル:"
        puts ""
        puts "  レベル1: 素数 2,3,5,7 を使用 / 2個の素数 / 数字50まで / 5問"
        puts "  レベル2: 素数 2,3,5,7 を使用 / 3個の素数 / 数字500まで / 5問"
        puts "  レベル3: 素数 2,3,5,7,11 を使用 / 4個の素数 / 数字1000まで / 5問"
        puts "  レベル4: 素数 2,3,5,7,11 を使用 / 4〜5個の素数 / 数字10000まで / 5問"
        puts ""
        puts "例: ruby bin/sospeed --level 3"
        puts "=" * 60
        exit 1
      end
      options[:difficulty] = :"level#{level}"
    end

    opts.on("--mode MODE", Integer, "入力モードを指定 (1=スペース区切り, 2=キーボード割り当て)") do |mode|
      unless (1..2).include?(mode)
        puts "=" * 60
        puts "エラー: モードは1または2を指定してください"
        puts "=" * 60
        puts ""
        puts "利用可能な入力モード:"
        puts ""
        puts "  モード1: スペース区切り入力方式"
        puts "    - 素因数を半角スペース区切りで入力"
        puts "    - 例: 2 3 5 と入力してEnterキーで確定"
        puts "    - 順序は問いません（2 5 3 でも正解）"
        puts ""
        puts "  モード2: キーボード割り当て方式"
        puts "    - キーボードに素数を割り当て"
        puts "    - a:2  s:3  d:5  f:7  g:11"
        puts "    - キーを押すと数字が表示され、Enterで確定"
        puts "    - Backspaceで削除可能"
        puts ""
        puts "例: ruby bin/sospeed --mode 2"
        puts "=" * 60
        exit 1
      end
      options[:input_mode] = mode == 1 ? :space_separated : :keyboard_mapping
    end

    opts.on("-q", "--questions NUM", Integer, "問題数を指定（裏モード）") do |num|
      unless (1..100).include?(num)
        puts "=" * 60
        puts "エラー: 問題数は1〜100の範囲で指定してください"
        puts "=" * 60
        puts ""
        puts "例: ruby bin/sospeed --questions 10"
        puts "    ruby bin/sospeed -q 20"
        puts ""
        puts "=" * 60
        exit 1
      end
      options[:question_count] = num
    end

    opts.on("-h", "--help", "このヘルプを表示") do
      puts opts
      exit
    end
  end.parse!

  options
end

# ゲーム実行
if __FILE__ == $0
  options = parse_options
  game = SoSpeed::GameEngine.new(
    difficulty: options[:difficulty],
    input_mode: options[:input_mode],
    question_count: options[:question_count]
  )
  game.start
end
