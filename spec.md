# 素因数分解スピードゲーム - SoSpeed

## 概要
出題された数値の素因数分解のスピードを競うゲーム。
レベル1〜4の難易度を選択し、5問を解き終わるまでの時間を計測し、最短タイムを目指す。

## プログラム情報
- **エントリーポイント**: `bin/sospeed`
- **言語**: Ruby
- **実行方法**:
  - ローカル環境: `ruby bin/sospeed`
  - Docker環境: `docker run --rm -it sospeed`（初回: `docker build -t sospeed .`）
- **コマンドラインオプション**:
  - `--level LEVEL` または `-l LEVEL`: 難易度を指定（1〜4）
  - `--mode MODE` または `-m MODE`: 入力モードを指定（1=スペース区切り、2=キーボード割り当て）
  - `--questions NUM` または `-q NUM`: 問題数を指定（1〜100、裏モード）
  - `--help` または `-h`: ヘルプを表示

## 遊び方

### 方法1: ローカル環境で実行（Ruby必須）

Rubyがインストールされている環境で実行する方法です。

```bash
# 通常モード（対話形式で難易度・操作方法・問題数を選択）
ruby bin/sospeed

# オプション指定モード
ruby bin/sospeed --level 3 --mode 2              # レベル3、キーボード方式、5問
ruby bin/sospeed --questions 10                  # 問題数を10問に指定（裏モード）
ruby bin/sospeed -l 2 -m 1 -q 20                 # 短縮形式も可能
```

**必要な環境:**
- Ruby 3.3以上（推奨）

### 方法2: Docker環境で実行（Ruby不要）

ローカル環境にRubyがインストールされていなくても、Dockerさえあればプレイできます。

**必要な環境:**
- Docker

**起動方法:**

```bash
# 初回のみ: Dockerイメージをビルド
docker build -t sospeed .

# 通常モード（対話形式）
docker run --rm -it sospeed

# オプション指定モード
docker run --rm -it sospeed --level 3 --mode 2
docker run --rm -it sospeed --questions 10
docker run --rm -it sospeed -l 2 -m 1 -q 20
```

**終了方法:**

ゲーム終了後、自動的にコンテナが削除されます（`--rm`オプションにより）。
途中で終了したい場合は `Ctrl+C` を押してください。

**補足:**
- 初回起動時はDockerイメージのビルドに時間がかかりますが、2回目以降は素早く起動します
- コードを編集した場合は `docker build -t sospeed .` で再ビルドが必要です

## ゲームルール

### 基本仕様
- **難易度**: レベル1〜4の4段階
- **操作方法**: 2種類の入力方式から選択可能
- **問題数**: 5問（デフォルト）、または`--questions`オプションで1〜100問を指定可能
- **問題形式**: 難易度に応じた素数を掛け合わせた数値を出題
- **制限時間**: なし（全問正解するまでの時間を計測）

### 難易度設定

#### レベル1（初心者向け）
- **使用する素数**: 2, 3, 5, 7
- **組み合わせ数**: 2個
- **数値の上限**: 50まで
- **例**: 6 (2×3), 14 (2×7), 35 (5×7)

#### レベル2（初級）
- **使用する素数**: 2, 3, 5, 7
- **組み合わせ数**: 3個
- **数値の上限**: 500まで
- **例**: 30 (2×3×5), 70 (2×5×7), 210 (2×3×5×7)

#### レベル3（中級）
- **使用する素数**: 2, 3, 5, 7, 11
- **組み合わせ数**: 4個
- **数値の上限**: 1000まで
- **例**: 210 (2×3×5×7), 770 (2×5×7×11), 462 (2×3×7×11)

#### レベル4（上級）
- **使用する素数**: 2, 3, 5, 7, 11
- **組み合わせ数**: 4〜5個
- **数値の上限**: 10000まで
- **例**: 1155 (3×5×7×11), 4620 (2×2×3×5×7×11)

### 問題生成ルール
- 各問題は難易度に応じた個数の素数をランダムに選択して掛け合わせて生成
- 同じ素数の重複を認める（例: 2×2×3 = 12）
- 出題される全問題の中で同じ数値は出題されない（重複なし）
- 生成された数値が上限を超える場合は再生成

### 操作方法

ゲーム開始前に2つの入力方式から選択できます。

#### 方式1: スペース区切り入力方式（従来型）
- **入力方法**: 素数をスペース区切りで入力してEnter
- **例**: `2 3 5` または `2 2 3` と入力してEnter
- **許可される文字**: 半角数字と半角スペースのみ
- **入力順序**: 不問（`2 3 5` でも `5 2 3` でも正解）
- **特徴**: 一度に全て入力してから確定

#### 方式2: キーボード割り当て方式（新方式）
- **入力方法**: 特定のキーを押すと対応する素数が表示され、Enterで確定
- **キー割り当て**:
  - `a` → 2
  - `s` → 3
  - `d` → 5
  - `f` → 7
  - `g` → 11
- **削除機能**: Backspaceで最後の入力を削除可能
- **入力順序**: 不問（押した順番に関係なく正解判定）
- **特徴**: リアルタイムで数値が表示される。視覚的に確認しながら入力できる

### 正解条件
- 素因数の**種類**と**個数**が完全一致していること
- 例: 12 (2×2×3) の場合
  - ✅ 正解: `2 2 3`, `3 2 2`, `2 3 2`
  - ❌ 不正解: `2 3` (2が1つ足りない)
  - ❌ 不正解: `2 2 2 3` (2が1つ多い)
  - ❌ 不正解: `4 3` (4は素数ではない)

## エラー処理

### 1. 空白入力（Enterのみ）
- **動作**: 無視して再入力を促す
- **待機時間**: なし
- **メッセージ**: なし

### 2. 不正な文字入力
- **対象**: 半角数字と半角スペース以外の文字（全角数字、文字、記号など）
- **動作**: エラーメッセージを表示し、2秒間待機後に再入力
- **メッセージ**: `数字を入力してください`
- **待機時間**: 2秒（計測時間に含まれる）

### 3. 素因数の不一致
- **対象**: 
  - 素因数が間違っている
  - 素因数の個数が少ない
  - 素因数の個数が多い
- **動作**: エラーメッセージを表示し、2秒間待機後に再入力
- **メッセージ**: `不正解です`
- **待機時間**: 2秒（計測時間に含まれる）

## ゲームフロー

```
1. スタート画面
   ↓
2. ルール説明表示
   ↓
3. Enterキー押下（次へ）
   ↓
4. 難易度選択画面
   - レベル1〜4を選択
   - 選択確認メッセージ表示
   ↓
5. 操作方法選択画面
   - 方式1（スペース区切り）または方式2（キーボード割り当て）を選択
   - 選択確認メッセージ表示
   ↓
6. Enterキー押下でゲーム開始
   ↓
7. 計測開始
   ↓
8. 第1問〜第5問を順次出題
   各問題:
   - 数値を表示
   - プレイヤーが素因数を入力（選択した方式で）
   - 正解判定
     - 正解 → 次の問題へ
     - 不正解 → エラー処理 → 再入力
   ↓
9. 全問正解
   ↓
10. 計測終了
   ↓
11. 結果表示（合計時間）
```

## 画面表示例

### スタート画面
```
==================================================
素数スピード練習プログラム
==================================================

ルール:
- 表示された数字を素因数分解してください
- 素数をスペース区切りで入力してください(例: 2 3 5)
- 順序は問いません
- N問すべて解くまでの時間を計測します（Nは指定された問題数）

Enterキーを押して次へ!
```

### 難易度選択画面
```
==================================================
難易度を選択してください
==================================================

1. レベル1 (素数: 2,3,5,7 / 2個 / 数字50まで)
2. レベル2 (素数: 2,3,5,7 / 3個 / 数字500まで)
3. レベル3 (素数: 2,3,5,7,11 / 4個 / 数字1000まで)
4. レベル4 (素数: 2,3,5,7,11 / 4〜5個 / 数字10000まで)

レベルを選択 (1-4) > 1

難易度: レベル1 が選択されました
```

### 操作方法選択画面
```
==================================================
操作方法を選択してください
==================================================

1. スペース区切り入力方式
   例: 2 3 5 と入力してEnter

2. キーボード割り当て方式
   a:2  s:3  d:5  f:7  g:11
   キーを押すと数字が表示され、Enterで確定
   Backspaceで削除可能

操作方法を選択 (1-2) > 2

操作方法: キーボード割り当て方式 が選択されました

Enterキーを押してスタート!
```

### 問題画面
```
--------------------------------------------------
第1問: 30
--------------------------------------------------
素因数を入力 > 
```

### 正解時（スペース区切り方式）
```
素因数を入力 > 2 3 5
正解!
```

### 正解時（キーボード割り当て方式）
```
素因数を入力 > 2 3 5
（aキー、sキー、dキーを押すとリアルタイムで「2 3 5 」と表示される）
（Enterキーで確定）
正解!
```

### Backspaceで削除（キーボード割り当て方式）
```
素因数を入力 > 2 3 11
（aキー、sキー、gキーを押して「2 3 11 」と表示）
（間違えたのでBackspaceを押すと「2 3 」になる）
（dキーを押して「2 3 5 」にする）
（Enterキーで確定）
正解!
```

### 不正解時（素因数の不一致）
```
素因数を入力 > 2 5
不正解です
（2秒待機）
素因数を入力 >
```

### 不正解時（不正な文字）※スペース区切り方式のみ
```
素因数を入力 > 2,3,5
数字を入力してください
（2秒待機）
素因数を入力 >
```

### 結果画面
```
==================================================
お疲れ様でした!
==================================================

合計時間: 45.23秒

==================================================
```

## 技術仕様

### クラス構成
- **SoSpeed**: メインゲームクラス
  - 定数:
    - `PRIMES_BASIC`: 基本の素数配列 [2, 3, 5, 7]
    - `PRIMES_ADVANCED`: 上級の素数配列 [2, 3, 5, 7, 11]
    - `DEFAULT_QUESTION_COUNT`: デフォルト問題数 (5)
    - `ERROR_WAIT_TIME`: エラー時の待機時間 (2秒)
    - `KEY_MAPPING`: キーボード割り当てのハッシュ
      - 'a' → 2, 's' → 3, 'd' → 5, 'f' → 7, 'g' → 11
    - `DIFFICULTY_SETTINGS`: 難易度設定のハッシュ
      - level1, level2, level3, level4 の設定を含む
      - 各レベル: name（名前）、primes（使用素数）、factor_count（組み合わせ数）、max_number（数値上限）

  - インスタンス変数:
    - `@questions`: 問題のリスト
    - `@start_time`: 計測開始時刻
    - `@difficulty`: 選択された難易度
    - `@input_mode`: 選択された操作方法（:space_separated または :keyboard_mapping）
    - `@question_count`: 問題数（デフォルト5、オプションで1〜100を指定可能）

  - 主要メソッド:
    - `select_difficulty`: 難易度を選択
    - `select_input_mode`: 操作方法を選択
    - `generate_questions`: 問題を生成（重複チェック・上限チェック付き）
    - `input_with_keyboard_mapping`: キーボード割り当て方式での入力処理
    - `start`: ゲーム開始
    - `solve_question`: 1問を解く（2つの入力方式に対応）
    - `valid_input?`: 入力の検証
    - `show_result`: 結果表示

### 計測時間に含まれるもの
- 問題を読む時間
- 入力する時間
- 誤答時の待機時間（2秒）
- すべての処理時間

### 計測時間に含まれないもの
- スタート画面でEnterを押すまでの時間
- 難易度選択画面でレベルを選ぶ時間
- 操作方法選択画面で入力方式を選ぶ時間
- 選択後にEnterを押してゲーム開始するまでの時間

## 実装済み機能
- ✅ 難易度設定（レベル1〜4）
- ✅ 使用する素数の範囲拡大（11まで）
- ✅ 問題の重複防止
- ✅ 数値上限設定
- ✅ 2種類の操作方法（スペース区切り / キーボード割り当て）
- ✅ キーボード割り当て方式でのBackspace削除機能
- ✅ コマンドラインオプション対応（難易度・入力モード・問題数の指定）
- ✅ 問題数指定機能（裏モード、1〜100問）

## 将来の拡張案
- タイムランキング機能
- 統計機能（平均タイム、最短タイムなど）
- レベルごとのベストタイム記録
- 素数13以上の追加（レベル5以上）
- キーボード割り当てのカスタマイズ機能
- 練習モード（制限時間なし、ヒント表示あり）